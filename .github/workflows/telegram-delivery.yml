name: Telegram Delivery
run-name: 'Telegram Delivery: ${{ github.ref_name }}'

on:
  workflow_run:
    workflows: ['Calibre News Delivery']
    types:
      - completed
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID of Calibre News Delivery'
        required: true

permissions:
  contents: read
  actions: read

jobs:
  telegram:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: calibre-news
    env:
      token: ${{ secrets.TELEGRAM_TOKEN }}
      chat_id: ${{ secrets.TELEGRAM_TO }}
      ext: ${{ secrets.FORMAT || 'epub' }}
    steps:
      - name: Checking Variables
        run: |
          if [ -z "$token" ] || [ -z "$chat_id" ]; then
            echo "Missing TELEGRAM_TOKEN or TELEGRAM_TO secret"; exit 1
          fi

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: Calibre-News-Delivery
          path: ebooks
          run-id: ${{ github.event.workflow_run.id || inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug Artifacts
        run: ls -R ebooks

      - name: Send to Telegram
        run: |
          count=$(find ebooks -type f -name "*.${ext,,}" | wc -l)
          if [ $count -eq 0 ]; then
             echo "No ebooks found to send"; exit 1
          fi
          
          find ebooks -type f -name "*.${ext,,}" -print0 | while read -d '' ebook_path; do
            # Use absolute path
            abs_path="$(pwd)/$ebook_path"
            filename="$(basename "$ebook_path")"
            
            if [ ! -r "$abs_path" ]; then
                echo "Error: File not readable: $abs_path"
                ls -l "$abs_path"
                continue
            fi

            echo "Sending: \"$filename\" (Size: $(du -h "$abs_path" | cut -f1))"
            
            # Add retry logic
            for i in {1..3}; do
                response=$(curl -s -w "%{http_code}" -X POST "https://api.telegram.org/bot${token}/sendDocument" \
                  -F chat_id="$chat_id" \
                  -F document=@"$abs_path" \
                  -F caption="$filename")
                
                http_code="${response: -3}"
                full_body="${response::-3}"

                if [[ "$http_code" == "200" ]]; then
                    echo "Success: $filename sent."
                    break
                else
                    echo "Attempt $i failed. HTTP: $http_code. Body: $full_body"
                    sleep 5
                fi
            done
          done
          echo "Processing complete"
