name: Telegram Delivery
run-name: 'Telegram Delivery: ${{ github.ref_name }}'

on:
  schedule:
    - cron: '30 0 * * *'
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  telegram:
    runs-on: ubuntu-latest
    environment: calibre-news
    env:
      token: ${{ secrets.TELEGRAM_TOKEN }}
      chat_id: ${{ secrets.TELEGRAM_TO }}
      ext: ${{ secrets.FORMAT || 'epub' }}
    steps:
      - name: Checking Variables
        run: |
          if [ -z "$token" ] || [ -z "$chat_id" ]; then
            echo "Missing TELEGRAM_TOKEN or TELEGRAM_TO secret"; exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Calibre
        run: |
          sudo apt-get update
          sudo apt-get install libegl1 libopengl0 libxcb-cursor0
          url=https://download.calibre-ebook.com/linux-installer.sh
          sudo -v && wget -nv -O- $url | sudo sh /dev/stdin

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Ebook
        run: |
          date_str=$(date +'%Y%m%d')
          # Output file with expected name: the_hindu_YYYYMMDD.epub
          filename="the_hindu_${date_str}.${ext,,}"
          
          # Assuming hindu.recipe is in the root as seen in file tree
          if [ ! -f "hindu.recipe" ]; then
            echo "hindu.recipe not found!"
            exit 1
          fi

          echo "Converting recipe..."
          # Convert to "temp_hindu.epub" then rename to ensure control over filename
          ebook-convert hindu.recipe "temp_hindu.${ext,,}"
          
          echo "Renaming to: $filename"
          mv "temp_hindu.${ext,,}" "$filename"
          
          echo "ebook_file=$filename" >> $GITHUB_ENV

      - name: Send to Telegram
        run: |
          filename="${{ env.ebook_file }}"
          
          if [ ! -r "$filename" ]; then
             echo "Ebook file not found: $filename"
             ls -l
             exit 1
          fi

          # Use a generic name for upload to avoid curl parsing issues with special chars
          # (Although the current naming scheme 'the_hindu_20260204.epub' is safe, this is proactive)
          upload_name="telegram_upload_$(date +%s).${ext,,}"
          cp "$filename" "$upload_name"

          echo "Sending: \"$filename\" via temp file \"$upload_name\""
          
          for i in {1..3}; do
              response=$(curl -s -w "%{http_code}" -X POST "https://api.telegram.org/bot${token}/sendDocument" \
                -g \
                -F chat_id="$chat_id" \
                -F document=@"$upload_name" \
                -F caption="$filename")
              
              http_code="${response: -3}"
              full_body="${response::-3}"

              if [[ "$http_code" == "200" ]]; then
                  echo "Success: $filename sent."
                  break
              else
                  echo "Attempt $i failed. HTTP: $http_code. Body: $full_body"
                  sleep 5
              fi
          done
          rm "$upload_name"
