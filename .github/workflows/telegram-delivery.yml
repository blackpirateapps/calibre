name: Telegram Delivery
run-name: 'Telegram Delivery: ${{ github.ref_name }}'

on:
  schedule:
    - cron: '30 0 * * *'
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  telegram:
    runs-on: ubuntu-latest
    environment: calibre-news
    env:
      token: ${{ secrets.TELEGRAM_TOKEN }}
      chat_id: ${{ secrets.TELEGRAM_TO }}
      ext: ${{ secrets.FORMAT || 'epub' }}
    steps:
      - name: Checking Variables
        run: |
          if [ -z "$token" ] || [ -z "$chat_id" ]; then
            echo "Missing TELEGRAM_TOKEN or TELEGRAM_TO secret"; exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Calibre
        run: |
          sudo apt-get update
          sudo apt-get install libegl1 libopengl0 libxcb-cursor0
          url=https://download.calibre-ebook.com/linux-installer.sh
          sudo -v && wget -nv -O- $url | sudo sh /dev/stdin

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Process Recipes
        run: |
          date_str=$(date +'%Y%m%d')
          
          # Function to process a single recipe
          process_recipe() {
            local recipe_path="$1"
            local recipe_name="$(basename "$recipe_path" .recipe)"
            # Standardize filename: name_YYYYMMDD.extension
            local filename="${recipe_name}_${date_str}.${ext,,}"
            
            echo "---------------------------------------------------"
            echo "Processing: $recipe_path"
            
            echo "Converting to temporary file..."
            ebook-convert "$recipe_path" "temp_ebook.${ext,,}"
            
            echo "Renaming to: $filename"
            mv "temp_ebook.${ext,,}" "$filename"
            
            # Send to Telegram
            if [ ! -r "$filename" ]; then
                echo "Error: Ebook file creation failed for $filename"
                ls -l
                return 1
            fi

            local upload_name="telegram_upload_$(date +%s)_${RANDOM}.${ext,,}"
            cp "$filename" "$upload_name"
            
            echo "Sending \"$filename\" via temp file \"$upload_name\"..."
            
            for i in {1..3}; do
                response=$(curl -s -w "%{http_code}" -X POST "https://api.telegram.org/bot${token}/sendDocument" \
                  -g \
                  -F chat_id="$chat_id" \
                  -F document=@"$upload_name" \
                  -F caption="$filename")
                
                http_code="${response: -3}"
                
                if [[ "$http_code" == "200" ]]; then
                    echo "Success: $filename sent."
                    break
                else
                    echo "Attempt $i failed. HTTP: $http_code."
                    sleep 5
                fi
            done
            rm "$upload_name"
            rm "$filename" # cleanup to save space
          }

          # 1. Process root hindu.recipe
          if [ -f "hindu.recipe" ]; then
            process_recipe "hindu.recipe"
          else
            echo "hindu.recipe not found in root, skipping."
          fi

          # 2. Process recipes in newspapers/ folder
          if [ -d "newspapers" ]; then
            shopt -s nullglob
            for recipe in newspapers/*.recipe; do
                process_recipe "$recipe"
            done
            shopt -u nullglob
          else
            echo "newspapers directory not found or empty."
          fi
          
          echo "All processing complete."
